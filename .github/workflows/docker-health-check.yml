name: Docker Health Check

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Checkout Config Repository
        uses: actions/checkout@v4
        with:
          repository: UruruLab/Ururu-AI-Config
          path: config
          token: ${{ secrets.GHCR_TOKEN }}

      - name: Copy Config Files to Docker Context
        run: |
          # Docker ë””ë ‰í† ë¦¬ ë‚´ì— config í´ë” ìƒì„±
          mkdir -p ./docker/config
          
          # config repositoryì˜ .env íŒŒì¼ë“¤ì„ docker/configì— ë³µì‚¬
          if compgen -G "config/.env*" > /dev/null; then
            cp config/.env* ./docker/config/
            echo "âœ… Config files copied to docker/config/ successfully"
          
            # ë³µì‚¬ëœ íŒŒì¼ í™•ì¸
            echo "ğŸ“ Copied files:"
            ls -la ./docker/config/
          else
            echo "âŒ Config files not found in config repository"
            exit 1
          fi

      - name: Verify Environment Files
        run: |
          echo "ğŸ“ Checking Docker context config files"
          ls -la ./docker/config/
          
          if [ -f "./docker/config/.env.development" ]; then
            echo "âœ… .env.development file exists in docker context"
          else
            echo "âŒ .env.development file missing in docker context"
            exit 1
          fi
          
          if [ -f "./docker/config/.env.production" ]; then
            echo "âœ… .env.production file exists in docker context"
          else
            echo "âŒ .env.production file missing in docker context"
            exit 1
          fi

      - name: Validate Docker Compose Configuration
        run: |
          echo "âœ… Validating main Docker Compose file syntax"
          cd docker && docker compose -f docker-compose-ai.yml config --quiet
          echo "âœ… Docker Compose validation completed"
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          ENVIRONMENT: production

      - name: Verify Environment Variable Bindings
        run: |
          echo "ğŸ” Verifying environment variable bindings"
          cd docker
          echo "Production environment configuration check:"
          ENVIRONMENT=production GHCR_TOKEN=${{ secrets.GHCR_TOKEN }} \
            docker compose config \
            | grep -A 10 "environment:" \
            | grep "^[[:space:]]*[[:alpha:]]" \
            | sed 's/=.*/=<redacted>/' \
            | head -10
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}

      - name: Simulate Health Check
        run: |
          echo "ğŸ” AI Service Health Check Simulation"
          echo "- Target: http://localhost:8000/health"
          echo "- Expected Response: {\"status\": \"healthy\", \"service\": \"ururu-ai-recommendation\"}"
          
          echo "ğŸ” Spring Backend Connection Test Simulation"
          echo "- VPC Target: http://10.0.5.114:8000/health (FastAPI EC2)"
          echo "- Actual connection only available in VPC environment"

      - name: Check Configuration Completeness
        run: |
          echo "ğŸ“¦ Checking configuration completeness"
          echo "- Docker Compose files: âœ…"
          echo "- Environment files: âœ…"
          echo "- Config repository integration: âœ…"
          
          # í™˜ê²½ë³„ í•„ìˆ˜ ë³€ìˆ˜ ì²´í¬
          echo "ğŸ” Checking required environment variables"
          cd docker
          if grep -q "SPRING_BOOT_BASE_URL" config/.env.production; then
            echo "âœ… SPRING_BOOT_BASE_URL configured"
          else
            echo "âš ï¸ SPRING_BOOT_BASE_URL not found in production config"
          fi

      - name: Generate Health Check Report
        run: |
          echo "ğŸ“Š Health Check Completion Report"
          echo "âœ… Docker Compose configuration files validated"
          echo "âœ… Config repository integration working"
          echo "âœ… Environment-specific configuration files verified"
          echo "âœ… Workflow configuration validated"
          echo "âœ… File path mapping corrected"
          echo "âš ï¸ Actual service status needs verification on EC2"
          echo ""
          echo "ğŸ”§ Next steps for deployment:"
          echo "1. Ensure FastAPI EC2 (10.0.5.114) is running"
          echo "2. Test VPC internal communication"
          echo "3. Run: git push origin main to trigger CI/CD"
          echo "4. Monitor deployment: docker compose ps && docker compose logs"