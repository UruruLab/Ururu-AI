name: Docker Health Check

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches: 
      - main
      - 'fix/*'
  pull_request:
    branches: 
      - main
      - 'fix/*'

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Config ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        repository: UruruLab/Ururu-AI-Config
        path: config
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Config íŒŒì¼ ë³µì‚¬ (.env íŒŒì¼ë“¤)
      run: |
        mkdir -p ./
        cp config/.env* ./
        echo "âœ… Config íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
        
    - name: í™˜ê²½ íŒŒì¼ í™•ì¸
      run: |
        echo "ğŸ“ ë³µì‚¬ëœ í™˜ê²½ íŒŒì¼ í™•ì¸"
        ls -la .env*
        if [ -f ".env.development" ]; then
          echo "âœ… .env.development íŒŒì¼ ì¡´ì¬"
        else
          echo "âŒ .env.development íŒŒì¼ ì—†ìŒ"
        fi
        if [ -f ".env.production" ]; then
          echo "âœ… .env.production íŒŒì¼ ì¡´ì¬"
        else
          echo "âŒ .env.production íŒŒì¼ ì—†ìŒ"
        fi
      
    - name: Docker Compose ì„¤ì • ê²€ì¦
      run: |
        echo "âœ… Docker Compose íŒŒì¼ êµ¬ë¬¸ ê²€ì¦"
        docker compose config --quiet
        echo "âœ… ê°œë°œí™˜ê²½ ì„¤ì • ê²€ì¦ (ë³µì‚¬ëœ Config íŒŒì¼ ì‚¬ìš©)"
        ENVIRONMENT=development docker compose -f docker-compose.development.yml config --quiet
        echo "âœ… ìš´ì˜í™˜ê²½ ì„¤ì • ê²€ì¦ (ë³µì‚¬ëœ Config íŒŒì¼ ì‚¬ìš©)"
        ENVIRONMENT=production docker compose -f docker-compose.production.yml config --quiet
        
    - name: í—¬ìŠ¤ì²´í¬ ì‹œë®¬ë ˆì´ì…˜
      run: |
        echo "ğŸ” AI ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ì‹œë®¬ë ˆì´ì…˜"
        echo "- ì²´í¬ ëŒ€ìƒ: http://localhost:8000/health"
        echo "- ì˜ˆìƒ ì‘ë‹µ: {\"status\": \"healthy\", \"service\": \"ururu-ai-recommendation\"}"
        
        echo "ğŸ” Spring Backend ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜"
        echo "- ì²´í¬ ëŒ€ìƒ: http://localhost:8080/health"
        echo "- ì‹¤ì œ ì—°ê²°ì€ EC2 í™˜ê²½ì—ì„œë§Œ ê°€ëŠ¥"
        
    - name: GitHub Container Registry ì´ë¯¸ì§€ í™•ì¸
      run: |
        echo "ğŸ“¦ ìµœì‹  Docker ì´ë¯¸ì§€ í™•ì¸"
        echo "- Registry: ghcr.io/${{ github.repository }}"
        echo "- ìµœì‹  íƒœê·¸: latest, main, develop"
        
    - name: í—¬ìŠ¤ì²´í¬ ë³´ê³ ì„œ
      run: |
        echo "ğŸ“Š í—¬ìŠ¤ì²´í¬ ì™„ë£Œ ë³´ê³ ì„œ"
        echo "âœ… Docker Compose ì„¤ì • íŒŒì¼ ì •ìƒ"
        echo "âœ… Config ë ˆí¬ì§€í† ë¦¬ ì—°ë™ ì •ìƒ"
        echo "âœ… í™˜ê²½ë³„ ì„¤ì • íŒŒì¼ ê²€ì¦ ì™„ë£Œ"
        echo "âœ… ì›Œí¬í”Œë¡œìš° ì„¤ì • ì •ìƒ"
        echo "âš ï¸  ì‹¤ì œ ì„œë¹„ìŠ¤ ìƒíƒœëŠ” EC2ì—ì„œ ë³„ë„ í™•ì¸ í•„ìš”"
        echo "ğŸ’¡ EC2ì—ì„œ ì‹¤í–‰: docker compose ps && docker compose logs"
