name: Performance Test

on:
  workflow_dispatch:
    inputs:
      test_duration:
        description: 'í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°„ (ì´ˆ)'
        required: true
        default: '60'
        type: string
      concurrent_users:
        description: 'ë™ì‹œ ì‚¬ìš©ì ìˆ˜'
        required: true
        default: '5'
        type: string

jobs:
  performance-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install locust requests fastapi uvicorn
        
    - name: í…ŒìŠ¤íŠ¸ìš© FastAPI ì„œë²„ ì‹œì‘
      run: |
        # ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì„œë²„ ìƒì„±
        cat > test_server.py << 'EOF'
        from fastapi import FastAPI
        import uvicorn
        import asyncio
        
        app = FastAPI(title="Test Ururu AI Server")
        
        @app.get("/health")
        async def health_check():
            return {"status": "healthy", "service": "ururu-ai-test"}
            
        @app.post("/api/v1/recommendations")
        async def mock_recommendations():
            await asyncio.sleep(0.1)  # ì‹¤ì œ AI ì²˜ë¦¬ ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜
            return {
                "recommendations": [
                    {"product_id": 1, "score": 0.95, "name": "í…ŒìŠ¤íŠ¸ ìƒí’ˆ 1"},
                    {"product_id": 2, "score": 0.89, "name": "í…ŒìŠ¤íŠ¸ ìƒí’ˆ 2"}
                ],
                "total_count": 2,
                "processing_time_ms": 100
            }
        EOF
        
        # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„œë²„ ì‹¤í–‰
        python -c "
        import uvicorn
        import sys
        sys.path.append('.')
        uvicorn.run('test_server:app', host='0.0.0.0', port=8000, log_level='warning')
        " &
        
        # ì„œë²„ ì‹œì‘ ëŒ€ê¸°
        sleep 10
        
    - name: ì„œë²„ ì¤€ë¹„ ìƒíƒœ í™•ì¸
      run: |
        for i in {1..30}; do
          if curl -f http://localhost:8000/health; then
            echo "âœ… í…ŒìŠ¤íŠ¸ ì„œë²„ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤."
            break
          fi
          echo "í…ŒìŠ¤íŠ¸ ì„œë²„ ì‹œì‘ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘... ($i/30)"
          sleep 2
        done
        
    - name: Locust ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ íŒŒì¼ ìƒì„±
      run: |
        cat > locustfile.py << 'EOF'
        from locust import HttpUser, task, between
        import json
        
        class UruruAITestUser(HttpUser):
            wait_time = between(1, 3)
            
            def on_start(self):
                self.client.verify = False
                
            @task(3)
            def get_recommendations(self):
                payload = {
                    "user_diagnosis": "ê±´ì„± í”¼ë¶€ë¡œ ìˆ˜ë¶„ì´ ë¶€ì¡±í•´ìš”",
                    "top_k": 10,
                    "max_price": 50000
                }
                
                with self.client.post(
                    "/api/v1/recommendations",
                    json=payload,
                    headers={"Content-Type": "application/json"},
                    catch_response=True
                ) as response:
                    if response.status_code == 200:
                        response.success()
                    else:
                        response.failure(f"ì¶”ì²œ API ì‹¤íŒ¨: {response.status_code}")
            
            @task(1)
            def health_check(self):
                with self.client.get("/health", catch_response=True) as response:
                    if response.status_code == 200:
                        response.success()
                    else:
                        response.failure(f"í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨: {response.status_code}")
        EOF
        
    - name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        echo "ğŸš€ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹œì‘ (ì‚¬ìš©ì: ${{ github.event.inputs.concurrent_users }}, ì‹œê°„: ${{ github.event.inputs.test_duration }}ì´ˆ)"
        locust \
          --host=http://localhost:8000 \
          --users=${{ github.event.inputs.concurrent_users }} \
          --spawn-rate=1 \
          --run-time=${{ github.event.inputs.test_duration }}s \
          --headless \
          --csv=performance_results \
          --html=performance_report.html || echo "ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
          
    - name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„
      run: |
        echo "=== ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ ==="
        if [ -f performance_results_stats.csv ]; then
          echo "ğŸ“Š ìš”ì²­ í†µê³„:"
          cat performance_results_stats.csv | head -5
          echo ""
          echo "âŒ ì‹¤íŒ¨ í†µê³„:"
          cat performance_results_failures.csv 2>/dev/null || echo "ì‹¤íŒ¨ ì—†ìŒ"
        else
          echo "âš ï¸ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        fi
        
        echo ""
        echo "=== í…ŒìŠ¤íŠ¸ í™˜ê²½ ì •ë³´ ==="
        echo "- ë™ì‹œ ì‚¬ìš©ì ìˆ˜: ${{ github.event.inputs.concurrent_users }}"
        echo "- í…ŒìŠ¤íŠ¸ ì‹œê°„: ${{ github.event.inputs.test_duration }}ì´ˆ"
        echo "- ì„œë²„ í™˜ê²½: GitHub Actions (ubuntu-latest)"
        echo "- í…ŒìŠ¤íŠ¸ ëŒ€ìƒ: Mock FastAPI ì„œë²„"
        
    - name: ê²°ê³¼ íŒŒì¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-test-results-${{ github.run_number }}
        path: |
          performance_results*.csv
          performance_report.html
          
    - name: í…ŒìŠ¤íŠ¸ ì™„ë£Œ ì •ë¦¬
      if: always()
      run: |
        echo "ğŸ§¹ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì •ë¦¬"
        pkill -f "uvicorn" || echo "ì„œë²„ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì™„ë£Œ"
        echo "âœ… ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
